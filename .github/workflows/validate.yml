---
name: Validate Packer Templates
on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
    paths:
      - "packfiles/**/*.json"
      - "hcl2/**/*.pkr.hcl"
      - "hcl2/**/*.pkrvars.hcl"

jobs:
  validate:
    name: Validate Packer Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "1.11.2"

      - name: Packer Init (HCL2)
        run: |
          echo "Initializing HCL2 templates..."
          for dir in hcl2/*/; do
            if [ -f "${dir}*.pkr.hcl" ]; then
              echo "Initializing ${dir}"
              cd "$dir"
              packer init . || echo "Warning: Init failed for ${dir}"
              cd - > /dev/null
            fi
          done

      - name: Validate JSON Templates
        run: |
          echo "Validating JSON templates..."
          find packfiles -name "*.json" -type f | while read template; do
            echo "Validating $template"
            # Use packer validate with minimal vars to check syntax
            packer validate \
              -var "build_number=0" \
              -var "region=${AWS_REGION:-eu-west-1}" \
              -var "subnet_id=" \
              -var "vpc_id=" \
              -syntax-only \
              "$template" || echo "Warning: Validation failed for $template"
          done

      - name: Validate HCL2 Templates
        run: |
          echo "Validating HCL2 templates..."
          for dir in hcl2/*/; do
            if [ -f "${dir}"*.pkr.hcl ]; then
              echo "Validating ${dir}"
              cd "$dir"
              packer validate . || echo "Warning: Validation failed for ${dir}"
              cd - > /dev/null
            fi
          done

      - name: Validation Summary
        run: echo "âœ“ Packer template validation completed"
